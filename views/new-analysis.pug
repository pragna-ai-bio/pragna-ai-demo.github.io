extends layout

block content
  if isUpdate
    h2 Update Analysis
    form#analysisForm(action=`/analysis/${analysis._id}/update` method="POST")
      +formFields()
  else
    h2 New Analysis
    form#analysisForm(action="/analysis" method="POST")
      input(type="hidden" name="isNew" value="1")
      +formFields()

mixin formFields()
  h3 Patient Details

  // --- NAME ---
  label Patient Name
  input(
    type="text"
    name="patientName"
    required
    class=(fieldErrors?.patientName ? "input-error" : "")
    value=(analysis?.patientName || patient?.name || "")
  )
  if fieldErrors?.patientName
    p.error-message= fieldErrors.patientName

  // --- AGE ---
  label Patient Age
  input(
    type="number"
    name="patientAge"
    required
    class=(fieldErrors?.patientAge ? "input-error" : "")
    value=(analysis?.patientAge || patient?.age || "")
  )
  if fieldErrors?.patientAge
    p.error-message= fieldErrors.patientAge

  // --- GENDER ---
  label Patient Gender
  select(
    name="patientGender"
    required
    class=(fieldErrors?.patientGender ? "input-error" : "")
  )
    option(value="" disabled selected=(!patient && !analysis)) Select Gender
    option(value="male" selected=(analysis?.patientGender === "male" || patient?.gender==="male")) Male
    option(value="female" selected=(analysis?.patientGender === "female" || patient?.gender==="female")) Female
    option(value="other" selected=(analysis?.patientGender === "other" || patient?.gender==="other")) Other

  if fieldErrors?.patientGender
    p.error-message= fieldErrors.patientGender

  h3 Molecular Readings

  // --- CARBONYL ---
  label Carbonyl Stretch
  input(
    type="number"
    step="0.01"
    name="molecularReadings[carbonylStretch]"
    required
    class=(fieldErrors?.["molecularReadings.carbonylStretch"] ? "input-error" : "")
    value=(analysis?.molecularReadings?.carbonylStretch || "")
  )
  if fieldErrors?.["molecularReadings.carbonylStretch"]
    p.error-message= fieldErrors["molecularReadings.carbonylStretch"]

  // --- METHYL DEFORMATION ---
  label Methyl Deformation
  input(
    type="number"
    step="0.01"
    name="molecularReadings[methylDeformation]"
    required
    class=(fieldErrors?.["molecularReadings.methylDeformation"] ? "input-error" : "")
    value=(analysis?.molecularReadings?.methylDeformation || "")
  )
  if fieldErrors?.["molecularReadings.methylDeformation"]
    p.error-message= fieldErrors["molecularReadings.methylDeformation"]

  // --- CARBON-OXYGEN ---
  label Carbon-Oxygen Stretch
  input(
    type="number"
    step="0.01"
    name="molecularReadings[carbonOxygenStretch]"
    required
    class=(fieldErrors?.["molecularReadings.carbonOxygenStretch"] ? "input-error" : "")
    value=(analysis?.molecularReadings?.carbonOxygenStretch || "")
  )
  if fieldErrors?.["molecularReadings.carbonOxygenStretch"]
    p.error-message= fieldErrors["molecularReadings.carbonOxygenStretch"]

  // --- HYDROXYL ---
  label Hydroxyl Stretch
  input(
    type="number"
    step="0.01"
    name="molecularReadings[hydroxylStretch]"
    required
    class=(fieldErrors?.["molecularReadings.hydroxylStretch"] ? "input-error" : "")
    value=(analysis?.molecularReadings?.hydroxylStretch || "")
  )
  if fieldErrors?.["molecularReadings.hydroxylStretch"]
    p.error-message= fieldErrors["molecularReadings.hydroxylStretch"]

  button(type="submit") #{isUpdate ? "Save & Recalculate" : "Run Analysis"}

  script.
    const form = document.getElementById('analysisForm');
    form.addEventListener('submit', () => {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';
    });
