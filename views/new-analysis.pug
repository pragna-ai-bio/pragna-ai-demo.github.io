extends layout

block content
  if isUpdate
    h2 Update Analysis
    form#analysisForm(action=`/analysis/${analysis._id}/update` method="POST")
      +formFields()
  else
    h2 New Analysis
    form#analysisForm(action="/analysis" method="POST")
      input(type="hidden" name="isNew" value="1")
      +formFields()

mixin formFields()
  h3 Patient Details

  // --- NAME ---
  label Patient Name
  input(
    type="text"
    name="patientName"
    required
    class=(fieldErrors && fieldErrors.patientName ? "input-error" : "")
    value=(
      analysis && analysis.patientName
        ? analysis.patientName
        : (patient && patient.name ? patient.name : "")
    )
  )
  if fieldErrors && fieldErrors.patientName
    p.error-message= fieldErrors.patientName

  // --- AGE ---
  label Patient Age
  input(
    type="number"
    name="patientAge"
    required
    class=(fieldErrors && fieldErrors.patientAge ? "input-error" : "")
    value=(
      analysis && analysis.patientAge
        ? analysis.patientAge
        : (patient && patient.age ? patient.age : "")
    )
  )
  if fieldErrors && fieldErrors.patientAge
    p.error-message= fieldErrors.patientAge

  // --- GENDER ---
  label Patient Gender
  select(
    name="patientGender"
    required
    class=(fieldErrors && fieldErrors.patientGender ? "input-error" : "")
  )
    option(value="" disabled selected=(!patient && !analysis)) Select Gender
    option(
      value="male"
      selected=(analysis && analysis.patientGender==="male" || patient && patient.gender==="male")
    ) Male
    option(
      value="female"
      selected=(analysis && analysis.patientGender==="female" || patient && patient.gender==="female")
    ) Female
    option(
      value="other"
      selected=(analysis && analysis.patientGender==="other" || patient && patient.gender==="other")
    ) Other

  if fieldErrors && fieldErrors.patientGender
    p.error-message= fieldErrors.patientGender

  h3 Molecular Readings

  // --- CARBONYL ---
  label Carbonyl Stretch
  input(
    type="number"
    step="0.01"
    name="molecularReadings[carbonylStretch]"
    required
    class=(fieldErrors && fieldErrors["molecularReadings.carbonylStretch"] ? "input-error" : "")
    value=(analysis && analysis.molecularReadings ? analysis.molecularReadings.carbonylStretch : "")
  )
  if fieldErrors && fieldErrors["molecularReadings.carbonylStretch"]
    p.error-message= fieldErrors["molecularReadings.carbonylStretch"]

  // --- METHYL ---
  label Methyl Deformation
  input(
    type="number"
    step="0.01"
    name="molecularReadings[methylDeformation]"
    required
    class=(fieldErrors && fieldErrors["molecularReadings.methylDeformation"] ? "input-error" : "")
    value=(analysis && analysis.molecularReadings ? analysis.molecularReadings.methylDeformation : "")
  )
  if fieldErrors && fieldErrors["molecularReadings.methylDeformation"]
    p.error-message= fieldErrors["molecularReadings.methylDeformation"]

  // --- CARBON OXYGEN ---
  label Carbon-Oxygen Stretch
  input(
    type="number"
    step="0.01"
    name="molecularReadings[carbonOxygenStretch]"
    required
    class=(fieldErrors && fieldErrors["molecularReadings.carbonOxygenStretch"] ? "input-error" : "")
    value=(analysis && analysis.molecularReadings ? analysis.molecularReadings.carbonOxygenStretch : "")
  )
  if fieldErrors && fieldErrors["molecularReadings.carbonOxygenStretch"]
    p.error-message= fieldErrors["molecularReadings.carbonOxygenStretch"]

  // --- HYDROXYL ---
  label Hydroxyl Stretch
  input(
    type="number"
    step="0.01"
    name="molecularReadings[hydroxylStretch]"
    required
    class=(fieldErrors && fieldErrors["molecularReadings.hydroxylStretch"] ? "input-error" : "")
    value=(analysis && analysis.molecularReadings ? analysis.molecularReadings.hydroxylStretch : "")
  )
  if fieldErrors && fieldErrors["molecularReadings.hydroxylStretch"]
    p.error-message= fieldErrors["molecularReadings.hydroxylStretch"]

  button(type="submit") #{isUpdate ? "Save & Recalculate" : "Run Analysis"}

  script.
    const form = document.getElementById('analysisForm');
    form.addEventListener('submit', () => {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';
    });
