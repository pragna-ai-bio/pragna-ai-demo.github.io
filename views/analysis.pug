extends layout

block content
  h2 Analysis for #{patient ? patient.name : 'New Patient'}

  // If patient exists, only allow updating
  if analysis
    form#analysisForm(action=`/analysis/${analysis._id}/update` method="POST")
      input(type="hidden" name="patientId" value=patient._id)
  else
    // Patient does not exist â†’ create both patient & analysis
    form#analysisForm(action="/analysis/" method="POST")

  // Patient details
  label Patient Name
  input(type="text" name="patientName" value=patient ? patient.name : "" required readonly=analysis ? true : false)
  label Patient Age
  input(type="number" name="patientAge" value=patient ? patient.age : "" required readonly=analysis ? true : false)
  label Patient Gender
  input(type="text" name="patientGender" value=patient ? patient.gender : "" required readonly=analysis ? true : false)

  // Molecular readings
  label Carbonyl Stretch
  input(type="number" step="0.01" name="molecularReadings[carbonylStretch]" value=analysis ? analysis.molecularReadings.carbonylStretch.value : "" required readonly=analysis ? true : false)

  label Methyl Deformation
  input(type="number" step="0.01" name="molecularReadings[methylDeformation]" value=analysis ? analysis.molecularReadings.methylDeformation.value : "" required readonly=analysis ? true : false)

  label Carbon-Oxygen Stretch
  input(type="number" step="0.01" name="molecularReadings[carbonOxygenStretch]" value=analysis ? analysis.molecularReadings.carbonOxygenStretch.value : "" required readonly=analysis ? true : false)

  label Hydroxyl Stretch
  input(type="number" step="0.01" name="molecularReadings[hydroxylStretch]" value=analysis ? analysis.molecularReadings.hydroxylStretch.value : "" required readonly=analysis ? true : false)

  // Show results if analysis exists
  if analysis
    h3 Results
    p Risk Level: #{analysis.analysisResults.riskLevel}
    p Cancer Probability: #{Math.round(analysis.analysisResults.cancerProbability * 100)}%
    p Confidence: #{Math.round(analysis.analysisResults.confidenceScore * 100)}%

    button#editBtn(type="button") Edit
    button#saveBtn(type="submit" style="display:none") Save & Recalculate
  else
    button(type="submit") Run Analysis

  // Enable editing on click
  if analysis
    script.
      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const inputs = document.querySelectorAll('input');

      editBtn.addEventListener('click', () => {
        inputs.forEach(i => i.removeAttribute('readonly'));
        saveBtn.style.display = 'inline-block';
        editBtn.style.display = 'none';
      });
